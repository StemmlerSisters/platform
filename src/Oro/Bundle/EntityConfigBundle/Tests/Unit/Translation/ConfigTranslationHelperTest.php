<?php

namespace Oro\Bundle\EntityConfigBundle\Tests\Unit\Translation;

use Oro\Bundle\EntityConfigBundle\Translation\ConfigTranslationHelper;
use Oro\Bundle\TranslationBundle\Entity\Translation;
use Oro\Bundle\TranslationBundle\Manager\TranslationManager;
use Oro\Bundle\TranslationBundle\Translation\Translator;
use PHPUnit\Framework\MockObject\MockObject;
use PHPUnit\Framework\TestCase;

class ConfigTranslationHelperTest extends TestCase
{
    private const LOCALE = 'en';

    private TranslationManager&MockObject $translationManager;
    private Translator&MockObject $translator;
    private ConfigTranslationHelper $helper;

    #[\Override]
    protected function setUp(): void
    {
        $this->translator = $this->createMock(Translator::class);
        $this->translationManager = $this->createMock(TranslationManager::class);

        $this->helper = new ConfigTranslationHelper(
            $this->translationManager,
            $this->translator
        );
    }

    /**
     * @dataProvider isTranslationEqualDataProvider
     */
    public function testIsTranslationEqual(string $translation, string $key, string $value, bool $expected): void
    {
        $this->translator->expects($this->once())
            ->method('trans')
            ->with($key)
            ->willReturn($translation);

        $this->assertEquals($expected, $this->helper->isTranslationEqual($key, $value));
    }

    public function isTranslationEqualDataProvider(): array
    {
        return [
            'equal' => [
                'translation' => 'valid translation',
                'key' => 'test',
                'value' => 'valid translation',
                'expected' => true
            ],
            'not equal' => [
                'translation' => 'valid translation',
                'key' => 'test',
                'value' => 'invalid value',
                'expected' => false
            ]
        ];
    }

    public function testInvalidateCache(): void
    {
        $locale = 'en';

        $this->translationManager->expects($this->once())
            ->method('invalidateCache')
            ->with($locale);

        $this->helper->invalidateCache($locale);
    }

    /**
     * @dataProvider saveTranslationsDataProvider
     */
    public function testSaveTranslations(array $translations, ?string $key = null, ?string $value = null): void
    {
        if ($translations) {
            $this->assertTranslationManagerCalled($key, $value);
            $this->assertTranslationServicesCalled();
        } else {
            $this->translationManager->expects($this->never())
                ->method($this->anything());
        }

        $this->helper->saveTranslations($translations);
    }

    public function saveTranslationsDataProvider(): array
    {
        $key = 'test.domain.label';
        $value = 'translation label';

        return [
            [
                'translations' => []
            ],
            [
                'translations' => [$key => $value],
                'key' => $key,
                'value' => $value
            ],
        ];
    }

    private function assertTranslationManagerCalled(string $key, string $value)
    {
        $trans = new Translation();

        $this->translationManager->expects($this->once())
            ->method('saveTranslation')
            ->with($key, $value, self::LOCALE, TranslationManager::DEFAULT_DOMAIN)
            ->willReturn($trans);

        $this->translationManager->expects($this->once())
            ->method('invalidateCache')
            ->with(self::LOCALE);

        $this->translationManager->expects($this->once())
            ->method('flush');
    }

    private function assertTranslationServicesCalled()
    {
        $this->translator->expects($this->once())
            ->method('getLocale')
            ->willReturn(self::LOCALE);
    }

    public function testTranslateWithFallbackTranslationExists(): void
    {
        $id = 'string';
        $translation = 'translation';
        $fallback = 'fallback';

        $this->translator->expects(self::once())
            ->method('hasTrans')
            ->with($id)
            ->willReturn(true);

        $this->translator->expects(self::once())
            ->method('trans')
            ->with($id)
            ->willReturn($translation);

        self::assertEquals($translation, $this->helper->translateWithFallback($id, $fallback));
    }

    public function testTranslateWithFallbackTranslationDoesntExist(): void
    {
        $id = 'string';
        $fallback = 'fallback';

        $this->translator->expects(self::once())
            ->method('hasTrans')
            ->with($id)
            ->willReturn(false);

        $this->translator->expects(self::never())
            ->method('trans');

        self::assertEquals($fallback, $this->helper->translateWithFallback($id, $fallback));
    }
}
